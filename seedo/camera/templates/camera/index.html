<!doctype html>
<html>
  <head>
    <title>Home</title>
    <script>
      async function sendSensorData(sensorData) {
        const response = await fetch('{% url "camera:fall_recognition" %}', {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}",
          },
          body: JSON.stringify({ sensor_data: sensorData }),
        });

        const result = await response.json();
        console.log("Prediction:", result.prediction);
        document.getElementById("fall_recognition").textContent =
          `'Prediction:', ${result.prediction}`;
      }

      class CircularBuffer {
        constructor(size) {
          this.size = size;
          this.buffer = [];
        }

        push(item) {
          if (this.buffer.length >= this.size) {
            this.buffer.shift();
          }
          if (
            item.acc &&
            item.acc.x !== undefined &&
            item.gyro &&
            item.gyro.alpha !== undefined
          ) {
            this.buffer.push(item);
            //console.log(item);
          }
        }

        getBuffer() {
          return this.buffer;
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        let model;
        let recording = false;
        let sensorDataBuffer = new CircularBuffer(29);
        let mediaRecorder;
        let recordedChunks = [];

        function maybeSendSensorData() {
          if (sensorDataBuffer.getBuffer().length >= 29) {
            const sensorData = sensorDataBuffer.getBuffer();
            sendSensorData(sensorData);
          }
        }
        function createNewFrame() {
          return {
            timestamp: Date.now(),
            gps: {},
            acc: {},
            gyro: {},
          };
        }

        async function updateSensorData(event) {
          const frame = createNewFrame();
          try {
            await Promise.all([
              updateGPS(frame),
              updateAccelerometer(event, frame),
              updateGyroscope(event, frame),
            ]);
            //updateMagnetometer(null, frame);
            sensorDataBuffer.push(frame);
            maybeSendSensorData();
          } catch (error) {
            console.error("Error updating sensor data:", error);
          }
        }

        function updateGPS(frame) {
          return new Promise((resolve, reject) => {
            if ("geolocation" in navigator) {
              navigator.geolocation.getCurrentPosition(
                function (position) {
                  frame.gps = {
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude,
                  };
                  document.getElementById("location").textContent =
                    `Location: Latitude ${position.coords.latitude}, Longitude ${position.coords.longitude}`;
                  resolve();
                },
                function (error) {
                  console.error("Error accessing GPS:", error);
                  frame.gps = {
                    latitude: "errortest",
                    longitude: "errortest",
                  };

                  document.getElementById("location").textContent =
                    `Location: Latitude "errortest", Longitude "errortest"`;
                  resolve();
                },
              );
            } else {
              console.error("Geolocation not supported");
              resolve();
            }
          });
        }

        function updateAccelerometer(event, frame) {
          return new Promise((resolve, reject) => {
            try {
              if (event.acceleration && recording) {
                let accel = event.acceleration;
                frame.acc = {
                  x: accel.x || 0,
                  y: accel.y || 0,
                  z: accel.z || 0,
                };
                document.getElementById("accelerometer").textContent =
                  `Accelerometer: x=${accel.x}, y=${accel.y}, z=${accel.z}`;
                resolve();
              }
            } catch {
              // Ensure the buffer is not empty before accessing the last item
              if (sensorDataBuffer.getBuffer().length > 0) {
                let lastItem =
                  sensorDataBuffer.getBuffer()[
                    sensorDataBuffer.getBuffer().length - 1
                  ];
                frame.acc = {
                  x: lastItem.acc.x || 0,
                  y: lastItem.acc.y || 0,
                  z: lastItem.acc.z || 0,
                };
              } else {
                frame.acc = {
                  x: 0,
                  y: 0,
                  z: 0,
                };
              }
              document.getElementById("accelerometer").textContent =
                `Accelerometer: x=1, y=1, z=1`;
              resolve();
            }
          });
        }

        function updateGyroscope(event, frame) {
          return new Promise((resolve, reject) => {
            try {
              if (event.alpha & recording) {
                frame.gyro = {
                  alpha: event.alpha || 0,
                  beta: event.beta || 0,
                  gamma: event.gamma || 0,
                };
                document.getElementById("gyroscope").textContent =
                  `Gyroscope: alpha=${event.alpha}, beta=${event.beta}, gamma=${event.gamma}`;
                resolve();
              }
            } catch {
              // Ensure the buffer is not empty before accessing the last item
              if (sensorDataBuffer.getBuffer().length > 0) {
                let lastItem =
                  sensorDataBuffer.getBuffer()[
                    sensorDataBuffer.getBuffer().length - 1
                  ];
                frame.gyro = {
                  alpha: lastItem.gyro.alpha || 0,
                  beta: lastItem.gyro.beta || 0,
                  gamma: lastItem.gyro.gamma || 0,
                };
              } else {
                frame.gyro = {
                  alpha: 0,
                  beta: 0,
                  gamma: 0,
                };
              }

              document.getElementById("gyroscope").textContent =
                `Gyroscope: alpha=1, beta=1, gamma=1`;
              resolve();
            }
          });
        }

        function startRecording() {
          recording = true;
          document.getElementById("recording-status").textContent =
            "Recording...";

          const video = document.getElementById("video");
          const canvas = document.getElementById("canvas");
          const context = canvas.getContext("2d");
          let frameId = 0;
          const frameRate = 30; // frames per second
          /*
          navigator.mediaDevices
            .getUserMedia({ video: true })
            .then(function (stream) {
              video.srcObject = stream;
              video.play();

              // Set up MediaRecorder
              mediaRecorder = new MediaRecorder(stream);
              mediaRecorder.ondataavailable = function (event) {
                if (event.data.size > 0) {
                  recordedChunks.push(event.data);
                }
              };
              mediaRecorder.start();
            })
            .catch(function (err) {
              console.log('An error occurred: ' + err);
            });
          */
          // Start sensor data logging
          if (window.DeviceMotionEvent) {
            window.addEventListener("devicemotion", updateSensorData);
          } else {
            console.error("Accelerometer not supported");
          }

          if (window.DeviceOrientationEvent) {
            window.addEventListener("deviceorientation", updateSensorData);
          } else {
            console.error("Gyroscope not supported");
          }

          setInterval(updateSensorData, 1000 / frameRate);
        }

        function stopRecording() {
          recording = false;
          document.getElementById("recording-status").textContent =
            "Recording stopped.";

          /*
          // Stop mediaRecorder and get the video data
          mediaRecorder.stop();
          mediaRecorder.onstop = function () {
            const videoBlob = new Blob(recordedChunks, { type: 'video/mp4' });
            const videoFile = new File([videoBlob], 'video.mp4', {
              type: 'video/mp4',
            });

            // Save sensor data to a file
            const sensorLogBlob = new Blob(
              [JSON.stringify(sensorDataBuffer.getBuffer(), null, 2)],
              {
                type: 'application/json',
              }
            );
            const sensorLogFile = new File([sensorLogBlob], 'sensor_log.json', {
              type: 'application/json',
            });

            // Stop video stream
            const video = document.getElementById('video');
            const stream = video.srcObject;
            const tracks = stream.getTracks();

            tracks.forEach(function (track) {
              track.stop();
            });

            video.srcObject = null;

            // Use DataTransfer to simulate file input
            const videoFileInput = document.getElementById('video-file');
            const sensorLogFileInput =
              document.getElementById('sensor-log-file');

            const videoDataTransfer = new DataTransfer();
            videoDataTransfer.items.add(videoFile);
            videoFileInput.files = videoDataTransfer.files;

            const logDataTransfer = new DataTransfer();
            logDataTransfer.items.add(sensorLogFile);
            sensorLogFileInput.files = logDataTransfer.files;

            // Submit the form
            document.getElementById('upload-form').submit();
          };
          */
          window.removeEventListener("devicemotion", updateSensorData);
          window.removeEventListener("deviceorientation", updateSensorData);
        }

        document
          .getElementById("start-camera")
          .addEventListener("click", startRecording);
        document
          .getElementById("stop-camera")
          .addEventListener("click", stopRecording);
      });
    </script>
  </head>
  <body>
    <h1>Sensor Data</h1>
    <p id="location">Location: Loading...</p>
    <p id="accelerometer">Accelerometer: Loading...</p>
    <p id="gyroscope">Gyroscope: Loading...</p>
    <p id="fall_recognition">fall_recognition: Loading...</p>
    <p id="recording-status">Recording status: Not recording</p>

    <button id="start-camera">Start Camera</button>
    <button id="stop-camera">Stop Camera</button>
    <form
      id="upload-form"
      method="post"
      enctype="multipart/form-data"
      action="{% url 'camera:upload_recording' %}"
    >
      {% csrf_token %}
      <input type="file" name="video" id="video-file" style="display: none" />
      <input
        type="file"
        name="sensor_log"
        id="sensor-log-file"
        style="display: none"
      />
      <button type="submit" style="display: none">Submit</button>
    </form>
    <video id="video" width="640" height="480" style="display: none"></video>
    <canvas id="canvas" width="640" height="480"></canvas>
  </body>
</html>
