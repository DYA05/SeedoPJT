{% extends "base.html" %} {% load static %} {% block extra_head %}
<link rel="stylesheet" href="{% static 'accounts/css/mypage.css' %}" />
{% endblock extra_head %} {% block content %}
<main>
  <div class="userName">아이디 | {{ user }}</div>
  <div class="partner">
    동반자 |
    <button id="addPartnerBtn">추가하기</button>
    <button id="removePartnerBtn">삭제하기</button>
  </div>
  <div class="partnerList">
    {% for partner in partner_list %}
    <div class="eachPartner">
      <span class="partnerName">{{ partner.user }}</span>
      {% if partner.is_accepted %}
      <!-- 수락된 경우 -->
      <a href="#" class="pBreakLog">시설</a>
      <a href="#" class="pAccidentLog">사고</a>
      {% else %} {% if partner.is_requester %}
      <!-- 요청을 보낸 경우 -->
      <p>아직 수락하지 않았습니다.</p>
      {% else %}
      <!-- 요청을 받은 경우 -->
      <button class="acceptBtn" data-request-id="{{ partner.request_id }}">
        수락하기
      </button>
      {% endif %} {% endif %}
    </div>
    {% empty %}
    <p>아직 동반자가 없습니다.</p>
    {% endfor %}
  </div>
  <a href="{% url 'accounts:account_logout' %}">로그아웃</a>
</main>

<!-- 모달 -->
<div id="addPartnerModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <form id="sendRequestForm">
      {% csrf_token %}
      <label for="email">이메일:</label>
      <input type="email" id="email" name="email" required />
      <button type="submit" id="sendRequestBtn">요청 보내기</button>
    </form>

    <!-- 검색 결과를 표시할 리스트 -->
    <ul id="searchResults"></ul>
  </div>
</div>

<div id="verifyRequestModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <form id="verifyRequestForm">
      {% csrf_token %}
      <label for="verificationCode">인증번호:</label>
      <input
        type="text"
        id="verificationCode"
        name="verificationCode"
        required
      />
      <button type="submit" id="verifyBtn">수락하기</button>
    </form>
  </div>
</div>

<script>
  var addPartnerBtn = document.getElementById("addPartnerBtn");
  var removePartnerBtn = document.getElementById("removePartnerBtn");
  var addPartnerModal = document.getElementById("addPartnerModal");
  var verifyRequestModal = document.getElementById("verifyRequestModal");
  var sendRequestForm = document.getElementById("sendRequestForm");
  var verifyRequestForm = document.getElementById("verifyRequestForm");
  var partnerList = document.querySelector(".partnerList");

  addPartnerBtn.addEventListener("click", function () {
    addPartnerModal.style.display = "block";
  });

  removePartnerBtn.addEventListener("click", function () {
    var selectedPartners = document.querySelectorAll(
      'input[name="selectPartner"]:checked',
    );
    selectedPartners.forEach((partner) => {
      partner.parentNode.remove();
    });
  });

  partnerList.addEventListener("click", function (event) {
    if (event.target.classList.contains("acceptBtn")) {
      var requestID = event.target.getAttribute("data-request-id");
      verifyRequestModal.style.display = "block";
      verifyRequestForm.setAttribute(
        "action",
        "/matching/accept_request/" + requestID + "/",
      );
    }
  });

  // Close modals
  var closeBtns = document.querySelectorAll(".close");
  closeBtns.forEach((btn) => {
    btn.addEventListener("click", function () {
      addPartnerModal.style.display = "none";
      verifyRequestModal.style.display = "none";
    });
  });

  // 이메일 검색 및 사용자 목록 표시
  document.getElementById("email").addEventListener("input", function () {
    var email = this.value.trim();
    var searchResults = document.getElementById("searchResults");

    // 입력된 이메일이 있을 때만 검색 요청
    if (email.length > 0) {
      fetch("/matching/search/?email=" + email)
        .then((response) => response.json())
        .then((data) => {
          console.log(data); // 서버에서 받은 데이터 확인

          // 검색 결과를 초기화
          searchResults.innerHTML = "";

          // 받은 사용자 목록을 리스트에 추가
          data.users.forEach((user) => {
            var li = document.createElement("li");
            li.textContent = user.email;
            li.setAttribute("data-user-id", user.id);

            li.onclick = function () {
              document.getElementById("email").value = user.email;
              searchResults.innerHTML = ""; // 목록 클릭 시 검색 결과 초기화
            };

            searchResults.appendChild(li); // 검색 결과 리스트에 추가
          });
        })
        .catch((error) => {
          console.error("Error fetching users:", error);
        });
    } else {
      searchResults.innerHTML = ""; // 입력값이 없을 때 검색 결과 초기화
    }
  });

  // 요청 보내기
  sendRequestForm.addEventListener("submit", function (event) {
    event.preventDefault();
    var email = document.getElementById("email").value.trim();
    fetch("/matching/send_request/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}",
      },
      body: JSON.stringify({ email: email }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.status === "success") {
          alert("요청이 성공적으로 보내졌습니다.");
          addPartnerModal.style.display = "none";
          console.log("success");
        } else {
          // 오류 메시지에 따라 다른 알림을 표시
          if (data.message === "이미 요청을 보냈습니다.") {
            alert("이미 요청을 보냈습니다.");
          } else if (data.message === "자신에게 요청을 보낼 수 없습니다.") {
            alert("자신에게 요청을 보낼 수 없습니다.");
          } else {
            alert("요청을 보내는 도중 오류가 발생했습니다.");
          }
          console.error(data.message);
        }
      })
      .catch((error) => {
        alert("요청을 보내는 도중 오류가 발생했습니다.");
        console.error("Error:", error);
      });
  });

  // 수락하기 버튼 클릭 시
  verifyRequestForm.addEventListener("submit", function (event) {
    event.preventDefault();
    var verificationCode = document
      .getElementById("verificationCode")
      .value.trim();
    fetch(this.getAttribute("action"), {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}",
      },
      body: JSON.stringify({ verification_code: verificationCode }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.status === "success") {
          alert("수락이 완료되었습니다.");
          verifyRequestModal.style.display = "none";
          console.log("success");

          // 수락 후 시설, 사고 버튼 표시
          var partnerName = document.querySelector(
            '.partnerName[data-request-id="' + requestID + '"]',
          );
          var pBreakLog = document.createElement("a");
          pBreakLog.href = "#";
          pBreakLog.textContent = "시설";
          pBreakLog.className = "pBreakLog";
          partnerName.parentNode.insertBefore(
            pBreakLog,
            partnerName.nextSibling,
          );

          var pAccidentLog = document.createElement("a");
          pAccidentLog.href = "#";
          pAccidentLog.textContent = "사고";
          pAccidentLog.className = "pAccidentLog";
          partnerName.parentNode.insertBefore(
            pAccidentLog,
            partnerName.nextSibling,
          );
        } else {
          alert("수락하는 도중 오류가 발생했습니다.");
          console.error(data.errors);
        }
      });
  });
</script>

{% endblock content %}
